# QuickShop 部署架构文档

## 项目概览
- **项目名称**: QuickShop (ecommerce-mini)
- **域名**: quickshop.fit
- **GitHub**: https://github.com/kimberlysue0003/ecommerce-mini

---

## 部署架构总结

### 前端部署 - AWS Amplify ✅
- **托管服务**: AWS Amplify
- **域名**: https://www.quickshop.fit
- **自动部署**: ✅ 是（连接 GitHub main 分支）
- **部署方式**: 每次 `git push` 到 main 分支，Amplify 自动构建和部署

**更新前端流程：**
```bash
# 1. 修改代码
# 2. 提交并推送
git add .
git commit -m "your message"
git push

# 3. 等待 Amplify 自动部署（通常 2-5 分钟）
# 4. 完成！无需手动操作
```

**关键点：**
- ❌ **不需要** SSH 到 EC2
- ❌ **不需要** 手动运行 `npm run build`
- ❌ **不需要** 手动重启 Nginx
- ✅ **只需要** git push，Amplify 全自动处理

**Amplify 控制台：**
https://console.aws.amazon.com/amplify/

---

### 后端部署 - AWS EC2 ✅
- **托管服务**: AWS EC2
- **域名**: https://api.quickshop.fit
- **服务器 IP**: 54.179.191.142
- **SSH 密钥**: `h:\Test\ecommerce-mini\ecommerce-key.pem`
- **代码路径**: `/home/ubuntu/ecommerce-mini/backend`
- **进程管理**: PM2
- **Web 服务器**: Nginx (反向代理)

**后端服务配置：**
- Node.js Express 运行在端口 3001
- PM2 自动重启和守护进程
- Nginx 反向代理 api.quickshop.fit → localhost:3001

**更新后端流程：**
```bash
# 1. SSH 连接到服务器
ssh -i ecommerce-key.pem ubuntu@54.179.191.142

# 2. 进入后端目录
cd /home/ubuntu/ecommerce-mini/backend

# 3. 拉取最新代码
git pull

# 4. 安装依赖（如果有新依赖）
npm install

# 5. 重启 PM2 进程
pm2 restart all

# 6. 退出
exit
```

**常用 PM2 命令：**
```bash
pm2 list              # 查看所有进程
pm2 logs              # 查看日志
pm2 restart all       # 重启所有进程
pm2 stop all          # 停止所有进程
pm2 monit             # 监控面板
```

---

### 数据库 - AWS RDS PostgreSQL
- **服务**: AWS RDS
- **引擎**: PostgreSQL
- **端点**: quickshop-db.ct2bo2pqbukk.us-east-1.rds.amazonaws.com
- **数据库名**: quickshop_db
- **端口**: 5432
- **访问方式**: 仅 EC2 可连接（通过 Security Group 限制）

**数据库连接：**
```bash
# 从 EC2 连接到 RDS
psql -h quickshop-db.ct2bo2pqbukk.us-east-1.rds.amazonaws.com \
     -U postgres \
     -d quickshop_db
```

---

## DNS 配置 (Namecheap)
- **域名注册商**: Namecheap
- **主域名**: quickshop.fit

**DNS 记录：**
```
www.quickshop.fit  → CNAME → Amplify 提供的域名
api.quickshop.fit  → A     → 54.179.191.142 (EC2 IP)
```

---

## SSL/HTTPS 配置
- **前端 (Amplify)**: 自动提供 SSL 证书
- **后端 (EC2)**: Let's Encrypt (certbot)

**更新 SSL 证书（EC2）：**
```bash
sudo certbot renew
sudo systemctl reload nginx
```

---

## Nginx 配置 (EC2)
**配置文件路径：** `/etc/nginx/sites-available/default`

**主要配置：**
- 监听 80 和 443 端口
- SSL 证书由 Let's Encrypt 提供
- 反向代理 → http://localhost:3001

**重启 Nginx：**
```bash
sudo systemctl reload nginx
sudo systemctl restart nginx
```

---

## 环境变量配置

### 前端 (.env.production)
```env
VITE_API_URL=https://api.quickshop.fit/api
VITE_GRAPHQL_URL=https://api.quickshop.fit/graphql
```

### 后端 (EC2: /home/ubuntu/ecommerce-mini/backend/.env)
```env
NODE_ENV=production
PORT=3001
DATABASE_URL=postgresql://...
CORS_ORIGIN=https://www.quickshop.fit
JWT_SECRET=...
STRIPE_SECRET_KEY=...
```

---

## 关键教训 ⚠️

### ❌ 常见错误
1. **前端改动后去 EC2 手动构建**
   - 错误！Amplify 会自动部署前端
   - EC2 上只需要更新后端

2. **混淆前端和后端的部署位置**
   - 前端 = Amplify（自动）
   - 后端 = EC2（需手动 SSH）

3. **忘记 PM2 重启后端**
   - 后端代码更新后必须重启 PM2

### ✅ 正确流程

**前端更新：**
```bash
git add .
git commit -m "update frontend"
git push
# Amplify 自动部署，等 2-5 分钟即可
```

**后端更新：**
```bash
# 本地提交推送
git push

# SSH 到 EC2
ssh -i ecommerce-key.pem ubuntu@54.179.191.142
cd /home/ubuntu/ecommerce-mini/backend
git pull
npm install  # 如果有新依赖
pm2 restart all
exit
```

**数据库迁移：**
```bash
# 在 EC2 上执行
cd /home/ubuntu/ecommerce-mini/backend
npx prisma migrate deploy
pm2 restart all
```

---

## 监控和统计

### Google Analytics
- **追踪 ID**: G-EHRGPSBNVW
- **控制台**: https://analytics.google.com/
- **配置位置**: `index.html` (前端)
- **部署方式**: 通过 Amplify 自动部署

**查看数据：**
1. 访问 Google Analytics 控制台
2. 选择 quickshop.fit 资源
3. 查看实时报告、用户统计、流量来源等

### AWS CloudWatch
- **EC2 监控**: CPU、内存、网络流量
- **RDS 监控**: 数据库连接数、查询性能
- **控制台**: https://console.aws.amazon.com/cloudwatch/

---

## 应急处理

### 网站无法访问
```bash
# 1. 检查 EC2 是否运行
# AWS Console → EC2 → Instances

# 2. SSH 到 EC2 检查服务
ssh -i ecommerce-key.pem ubuntu@54.179.191.142

# 3. 检查后端进程
pm2 list
pm2 logs

# 4. 检查 Nginx
sudo systemctl status nginx
sudo nginx -t  # 测试配置

# 5. 重启服务
pm2 restart all
sudo systemctl restart nginx
```

### 数据库连接失败
```bash
# 检查 RDS 状态
# AWS Console → RDS → Databases

# 检查 Security Group
# 确保 EC2 可以访问 RDS 5432 端口

# 测试连接
telnet quickshop-db.ct2bo2pqbukk.us-east-1.rds.amazonaws.com 5432
```

---

## 成本估算 (每月)
- **EC2 t2.micro**: ~$10
- **RDS db.t3.micro**: ~$15
- **AWS Amplify**: 免费套餐内（低流量）
- **域名**: ~$1/月
- **总计**: ~$26/月

---

## 备份策略
- **代码**: GitHub 自动备份
- **数据库**: RDS 自动快照（每天）
- **配置文件**: 需手动备份 EC2 上的配置

---

## 总结：记住这些就够了

1. **前端改动** = `git push` → Amplify 自动部署（无需手动操作）
2. **后端改动** = `git push` → SSH 到 EC2 → `git pull` → `pm2 restart all`
3. **数据库改动** = SSH 到 EC2 → `prisma migrate deploy`
4. **SSL 更新** = SSH 到 EC2 → `sudo certbot renew`
5. **查看统计** = Google Analytics（不是 AWS Console）

**下次部署其他项目，照着这个架构来就行了！**
